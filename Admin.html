<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Daily Deal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        
        /* Glass Panel */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* Sidebar & Nav */
        .sidebar-link { transition: all 0.3s; cursor: pointer; border-left: 3px solid transparent; }
        .sidebar-link:hover, .sidebar-link.active { background: rgba(56, 189, 248, 0.1); border-left-color: #38bdf8; color: #38bdf8; }
        
        /* Checkbox Custom */
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #3b82f6; }

        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hide { display: none !important; }
        
        /* Table Styles */
        .table-row-hover:hover { background-color: rgba(255,255,255,0.03); }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <div id="login-section" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0f172a]">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md border border-slate-700 text-center">
            <i class="fas fa-shield-alt text-5xl text-blue-500 mb-3"></i>
            <h2 class="text-2xl font-bold text-white mb-6">Admin Portal</h2>
            <form id="login-form" class="space-y-4">
                <input type="email" id="admin-email" placeholder="Email" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none" required>
                <input type="password" id="admin-pass" placeholder="Password" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg">Login</button>
            </form>
        </div>
    </div>

    <div id="dashboard-layout" class="flex h-full hide">
        
        <div class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col hidden md:flex">
            <div class="p-5 border-b border-slate-800 flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-gradient-to-tr from-blue-600 to-cyan-500 flex items-center justify-center font-bold text-white">A</div>
                <h1 class="font-bold text-lg tracking-wide">DailyDeal</h1>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <div onclick="switchTab('home')" class="sidebar-link active p-3 rounded flex items-center gap-3 text-slate-400">
                    <i class="fas fa-chart-pie w-5"></i> Dashboard
                </div>
                <div onclick="switchTab('withdrawals')" class="sidebar-link p-3 rounded flex items-center gap-3 text-slate-400">
                    <i class="fas fa-wallet w-5"></i> Requests <span id="badge-pending" class="ml-auto bg-red-500 text-white text-[10px] px-2 rounded-full hidden">0</span>
                </div>
                <div onclick="switchTab('history')" class="sidebar-link p-3 rounded flex items-center gap-3 text-slate-400">
                    <i class="fas fa-history w-5"></i> History & Report
                </div>
                <div onclick="switchTab('users')" class="sidebar-link p-3 rounded flex items-center gap-3 text-slate-400">
                    <i class="fas fa-users w-5"></i> Users
                </div>
                <div onclick="switchTab('tasks')" class="sidebar-link p-3 rounded flex items-center gap-3 text-slate-400">
                    <i class="fas fa-tasks w-5"></i> Tasks
                </div>
                <div onclick="switchTab('settings')" class="sidebar-link p-3 rounded flex items-center gap-3 text-slate-400">
                    <i class="fas fa-cogs w-5"></i> Settings
                </div>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="w-full bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white p-2 rounded transition flex items-center justify-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="md:hidden fixed top-0 w-full bg-slate-900 border-b border-slate-800 z-40 p-3 flex justify-between items-center shadow-lg">
             <span class="font-bold text-lg">DailyDeal Admin</span>
             <button onclick="toggleMobileMenu()" class="text-white text-xl"><i class="fas fa-bars"></i></button>
        </div>

        <div class="flex-1 bg-[#0f172a] overflow-auto relative p-6 custom-scroll mt-14 md:mt-0">
            
            <div id="view-home" class="page-view animate-fade">
                <h2 class="text-2xl font-bold mb-6 border-l-4 border-blue-500 pl-3">Overview</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="glass-panel p-4 rounded-xl border-t-2 border-green-500">
                        <div class="text-slate-400 text-xs uppercase">Users</div>
                        <div class="text-2xl font-bold" id="dash-users">0</div>
                    </div>
                    <div class="glass-panel p-4 rounded-xl border-t-2 border-yellow-500">
                        <div class="text-slate-400 text-xs uppercase">Pending</div>
                        <div class="text-2xl font-bold text-yellow-400" id="dash-pending">0</div>
                    </div>
                    <div class="glass-panel p-4 rounded-xl border-t-2 border-blue-500">
                        <div class="text-slate-400 text-xs uppercase">User Balance</div>
                        <div class="text-2xl font-bold text-blue-400" id="dash-balance">0</div>
                    </div>
                    <div class="glass-panel p-4 rounded-xl border-t-2 border-purple-500">
                        <div class="text-slate-400 text-xs uppercase">Paid Out</div>
                        <div class="text-2xl font-bold text-purple-400" id="dash-paid">0</div>
                    </div>
                </div>
            </div>

            <div id="view-withdrawals" class="page-view hide">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-2xl font-bold border-l-4 border-yellow-500 pl-3">Pending Requests</h2>
                    
                    <div id="bulk-actions" class="hidden flex gap-2 animate-pulse">
                        <button onclick="bulkProcess('paid')" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded shadow text-xs font-bold">
                            <i class="fas fa-check-double mr-1"></i> Approve Selected
                        </button>
                        <button onclick="bulkProcess('reject')" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded shadow text-xs font-bold">
                            <i class="fas fa-times-circle mr-1"></i> Reject Selected
                        </button>
                    </div>
                </div>
                
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-slate-300">
                            <thead class="bg-slate-800 text-xs uppercase font-bold text-slate-400">
                                <tr>
                                    <th class="p-4 w-10"><input type="checkbox" id="select-all" class="custom-checkbox" onclick="toggleSelectAll()"></th>
                                    <th class="p-4">User</th>
                                    <th class="p-4">Method & Number</th>
                                    <th class="p-4">Amount</th>
                                    <th class="p-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawals-table" class="divide-y divide-slate-700">
                                <tr><td colspan="5" class="p-6 text-center text-slate-500">Loading requests...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-history" class="page-view hide">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold border-l-4 border-indigo-500 pl-3">Transaction History</h2>
                    <button onclick="downloadPDF()" class="bg-slate-700 hover:bg-white hover:text-black text-white px-4 py-2 rounded-lg font-bold transition flex items-center gap-2">
                        <i class="fas fa-file-pdf text-red-500"></i> Download Report
                    </button>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-slate-300" id="history-data-table">
                            <thead class="bg-slate-800 text-xs uppercase font-bold text-slate-400">
                                <tr>
                                    <th class="p-4">Date</th>
                                    <th class="p-4">User Name</th>
                                    <th class="p-4">Method</th>
                                    <th class="p-4">Number</th>
                                    <th class="p-4">Amount</th>
                                    <th class="p-4">Status</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-slate-700">
                                <tr><td colspan="6" class="p-6 text-center">Loading history...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-users" class="page-view hide">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold border-l-4 border-purple-500 pl-3">Users</h2>
                    <input type="text" id="user-search" placeholder="Search..." onkeyup="filterUsers()" class="bg-slate-800 border border-slate-700 p-2 rounded text-sm w-40 md:w-64 focus:border-blue-500 outline-none">
                </div>
                <div class="glass-panel rounded-xl overflow-hidden overflow-x-auto">
                    <table class="w-full text-left text-sm text-slate-300">
                        <thead class="bg-slate-800 text-xs uppercase font-bold text-slate-400">
                            <tr>
                                <th class="p-4">Name/UID</th>
                                <th class="p-4">Balance</th>
                                <th class="p-4">Status</th>
                                <th class="p-4 text-right">Edit</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-tasks" class="page-view hide">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold border-l-4 border-pink-500 pl-3">Tasks</h2>
                    <button onclick="addTaskPopup()" class="bg-pink-600 hover:bg-pink-500 px-3 py-1.5 rounded font-bold text-sm"><i class="fas fa-plus"></i> Add</button>
                </div>
                <div id="tasks-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>

            <div id="view-settings" class="page-view hide">
                <h2 class="text-2xl font-bold mb-6 border-l-4 border-slate-500 pl-3">App Settings</h2>
                <div class="glass-panel p-6 rounded-xl max-w-2xl">
                    <form id="settings-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs text-slate-400 block mb-1">Daily Bonus</label><input type="number" id="set-bonus" class="w-full bg-slate-900 border border-slate-700 p-2 rounded text-white"></div>
                            <div><label class="text-xs text-slate-400 block mb-1">Min Withdraw</label><input type="number" id="set-min" class="w-full bg-slate-900 border border-slate-700 p-2 rounded text-white"></div>
                        </div>
                        <div><label class="text-xs text-slate-400 block mb-1">Monetag Zone ID</label><input type="text" id="set-zone" class="w-full bg-slate-900 border border-slate-700 p-2 rounded text-white"></div>
                        <div><label class="text-xs text-slate-400 block mb-1">Notice Text</label><textarea id="set-notice" rows="2" class="w-full bg-slate-900 border border-slate-700 p-2 rounded text-white"></textarea></div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-500 py-2 rounded font-bold">Save Changes</button>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, updateDoc, writeBatch,
            onSnapshot, collection, query, where, orderBy, 
            deleteDoc, addDoc, serverTimestamp, increment 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyAqFUJ41ol_IGO1Qq1nC3ItLBgi_GGduxE",
          authDomain: "daily-deal-dfdaa.firebaseapp.com",
          projectId: "daily-deal-dfdaa",
          storageBucket: "daily-deal-dfdaa.firebasestorage.app",
          messagingSenderId: "1002150750060",
          appId: "1:1002150750060:web:f7c5208dd2ce6cb3953549"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL VARIABLES ---
        let allUsers = [];
        let selectedWithdrawals = new Set();
        let pendingWithdrawalsData = [];
        let historyData = [];

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-section').classList.add('hide');
                document.getElementById('dashboard-layout').classList.remove('hide');
                initDashboard();
            } else {
                document.getElementById('login-section').classList.remove('hide');
                document.getElementById('dashboard-layout').classList.add('hide');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-pass').value;
            signInWithEmailAndPassword(auth, email, pass).catch(e => Swal.fire('Error', e.message, 'error'));
        });

        window.logout = () => signOut(auth).then(() => location.reload());
        window.toggleMobileMenu = () => document.querySelector('.w-64').classList.toggle('hidden');

        // --- DASHBOARD DATA ---
        function initDashboard() {
            // 1. Users Stream
            onSnapshot(collection(db, "users"), (snap) => {
                allUsers = [];
                let totalBal = 0, totalPaid = 0;
                snap.forEach(d => {
                    const u = d.data(); u.uid = d.id;
                    allUsers.push(u);
                    totalBal += (u.balance || 0);
                    totalPaid += (u.totalWithdraw || 0);
                });
                document.getElementById('dash-users').innerText = allUsers.length;
                document.getElementById('dash-balance').innerText = totalBal.toFixed(0);
                document.getElementById('dash-paid').innerText = totalPaid.toFixed(0);
                renderUsers();
            });

            // 2. Pending Withdrawals Stream
            const qP = query(collection(db, "withdrawals"), where("status", "==", "pending"));
            onSnapshot(qP, (snap) => {
                pendingWithdrawalsData = [];
                snap.forEach(d => pendingWithdrawalsData.push({id: d.id, ...d.data()}));
                
                document.getElementById('dash-pending').innerText = snap.size;
                const badge = document.getElementById('badge-pending');
                badge.innerText = snap.size;
                badge.classList.toggle('hidden', snap.size === 0);
                
                renderPendingWithdrawals();
            });

            // 3. History Stream (Paid/Rejected)
            // Note: In a real app, use orderBy and limit. Here we filter client side for simplicity without creating complex indexes
            const qH = query(collection(db, "withdrawals"), where("status", "in", ["paid", "reject"]));
            onSnapshot(qH, (snap) => {
                historyData = [];
                snap.forEach(d => historyData.push({id: d.id, ...d.data()}));
                // Sort by date desc manually since we didn't use orderBy in query to avoid index errors
                historyData.sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                renderHistory();
            });

            // 4. Tasks & Settings
            loadTasks();
            loadSettings();
        }

        // --- WITHDRAWALS: PENDING & BULK ---
        function renderPendingWithdrawals() {
            const tbody = document.getElementById('withdrawals-table');
            tbody.innerHTML = '';
            selectedWithdrawals.clear();
            updateBulkUI();

            if (pendingWithdrawalsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-slate-500">No pending requests</td></tr>';
                return;
            }

            pendingWithdrawalsData.forEach(w => {
                tbody.innerHTML += `
                    <tr class="table-row-hover border-b border-slate-700/50">
                        <td class="p-4"><input type="checkbox" class="custom-checkbox wd-checkbox" value="${w.id}" onclick="toggleSelect('${w.id}')"></td>
                        <td class="p-4">
                            <div class="font-bold text-white">${w.username}</div>
                            <div class="text-[10px] text-slate-500">${w.userId}</div>
                        </td>
                        <td class="p-4">
                            <div class="flex items-center gap-2">
                                <span class="bg-slate-700 px-2 py-0.5 rounded text-xs font-bold">${w.method}</span>
                                <span class="font-mono text-slate-300 select-all">${w.number}</span>
                            </div>
                        </td>
                        <td class="p-4 font-bold text-yellow-400">${w.amount}</td>
                        <td class="p-4 text-right">
                            <button onclick="singleProcess('${w.id}', 'paid', ${w.amount}, '${w.userId}')" class="text-green-500 hover:bg-green-500/20 p-2 rounded mr-1"><i class="fas fa-check"></i></button>
                            <button onclick="singleProcess('${w.id}', 'reject', ${w.amount}, '${w.userId}')" class="text-red-500 hover:bg-red-500/20 p-2 rounded"><i class="fas fa-times"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        window.toggleSelect = (id) => {
            if (selectedWithdrawals.has(id)) selectedWithdrawals.delete(id);
            else selectedWithdrawals.add(id);
            updateBulkUI();
        }

        window.toggleSelectAll = () => {
            const allBoxes = document.querySelectorAll('.wd-checkbox');
            const mainBox = document.getElementById('select-all');
            selectedWithdrawals.clear();
            
            if(mainBox.checked) {
                allBoxes.forEach(box => {
                    box.checked = true;
                    selectedWithdrawals.add(box.value);
                });
            } else {
                allBoxes.forEach(box => box.checked = false);
            }
            updateBulkUI();
        }

        function updateBulkUI() {
            const bar = document.getElementById('bulk-actions');
            if (selectedWithdrawals.size > 0) {
                bar.classList.remove('hidden');
                bar.innerHTML = `
                    <span class="text-xs text-slate-400 flex items-center mr-2">${selectedWithdrawals.size} Selected</span>
                    <button onclick="bulkProcess('paid')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded shadow text-xs font-bold mr-2">Approve All</button>
                    <button onclick="bulkProcess('reject')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded shadow text-xs font-bold">Reject All</button>
                `;
            } else {
                bar.classList.add('hidden');
            }
        }

        // --- ACTION LOGIC (Single & Bulk) ---
        // Single Action
        window.singleProcess = async (id, action, amount, uid) => {
             Swal.fire({
                title: action === 'paid' ? 'Confirm Payment?' : 'Reject Request?',
                icon: 'question', showCancelButton: true, confirmButtonColor: action === 'paid' ? '#10b981':'#ef4444',
                background: '#1e293b', color: '#fff'
            }).then(async (r) => {
                if(r.isConfirmed) {
                    try {
                        await updateDoc(doc(db, "withdrawals", id), { status: action });
                        if(action === 'reject') {
                            await updateDoc(doc(db, "users", uid), { balance: increment(amount), totalWithdraw: increment(-amount) });
                        }
                        Swal.fire({icon: 'success', title: 'Done', toast: true, position: 'top-end', timer: 1500, showConfirmButton: false});
                    } catch(e) { Swal.fire('Error', e.message, 'error'); }
                }
            });
        }

        // Bulk Action (Using writeBatch)
        window.bulkProcess = async (action) => {
            if(selectedWithdrawals.size === 0) return;
            
            Swal.fire({
                title: `Process ${selectedWithdrawals.size} items?`,
                text: `Action: ${action.toUpperCase()}`,
                icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, Proceed',
                background: '#1e293b', color: '#fff'
            }).then(async (r) => {
                if(r.isConfirmed) {
                    Swal.showLoading();
                    const batch = writeBatch(db); // Correct Batch Initialization
                    
                    const list = pendingWithdrawalsData.filter(x => selectedWithdrawals.has(x.id));
                    
                    list.forEach(item => {
                        const ref = doc(db, "withdrawals", item.id);
                        batch.update(ref, { status: action });
                        
                        if(action === 'reject') {
                            const userRef = doc(db, "users", item.userId);
                            batch.update(userRef, { 
                                balance: increment(item.amount), 
                                totalWithdraw: increment(-item.amount) 
                            });
                        }
                    });

                    try {
                        await batch.commit();
                        selectedWithdrawals.clear();
                        document.getElementById('select-all').checked = false;
                        updateBulkUI();
                        Swal.fire({icon: 'success', title: 'Bulk Action Completed!', background: '#1e293b', color:'#fff'});
                    } catch(e) {
                        console.error(e);
                        Swal.fire('Error', 'Bulk update failed: ' + e.message, 'error');
                    }
                }
            });
        }

        // --- HISTORY & PDF ---
        function renderHistory() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            if(historyData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-500">No history found</td></tr>';
                return;
            }

            historyData.forEach(h => {
                const dateStr = h.date ? new Date(h.date.seconds*1000).toLocaleDateString() : '-';
                const statusColor = h.status === 'paid' ? 'text-green-400' : 'text-red-400';
                
                tbody.innerHTML += `
                    <tr class="border-b border-slate-700/50">
                        <td class="p-4 text-xs text-slate-400">${dateStr}</td>
                        <td class="p-4 font-bold text-slate-200">${h.username}</td>
                        <td class="p-4 text-xs">${h.method}</td>
                        <td class="p-4 font-mono select-all">${h.number}</td>
                        <td class="p-4 font-bold text-white">${h.amount}</td>
                        <td class="p-4 font-bold text-xs uppercase ${statusColor}">${h.status}</td>
                    </tr>
                `;
            });
        }

        window.downloadPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Branding
            doc.setFillColor(15, 23, 42); // Slate 900
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text("Daily Deal App", 14, 20);
            doc.setFontSize(10);
            doc.text("Transaction History Report", 14, 30);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 35);
            
            // Table
            doc.autoTable({
                html: '#history-data-table',
                startY: 45,
                theme: 'grid',
                headStyles: { fillColor: [30, 41, 59], textColor: 255 },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                styles: { fontSize: 8, cellPadding: 3 }
            });

            // Footer
            const totalAmount = historyData.filter(x => x.status === 'paid').reduce((a,b) => a + (b.amount || 0), 0);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total Paid Amount: ${totalAmount} Coins`, 14, doc.lastAutoTable.finalY + 10);
            
            doc.save(`Report_${new Date().toISOString().slice(0,10)}.pdf`);
        }

        // --- USER MGMT & SETTINGS (Simplified for brevity) ---
        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            // Show only first 20 for perf, rely on search for others
            allUsers.slice(0, 20).forEach(u => {
                tbody.innerHTML += `
                    <tr class="border-b border-slate-700/50">
                        <td class="p-3">
                            <div class="font-bold text-white">${u.firstName}</div>
                            <div class="text-[10px] text-slate-500">${u.uid}</div>
                        </td>
                        <td class="p-3 text-yellow-400">${u.balance.toFixed(2)}</td>
                        <td class="p-3 text-xs">${u.banned ? '<span class="text-red-500">Banned</span>':'<span class="text-green-500">Active</span>'}</td>
                        <td class="p-3 text-right">
                            <button onclick="editUser('${u.uid}', ${u.balance})" class="text-blue-400 hover:text-white"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>
                `;
            });
        }
        
        window.filterUsers = () => {
            const q = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => (u.firstName && u.firstName.toLowerCase().includes(q)) || u.uid.includes(q));
            // Re-render based on filtered (simplified logic here)
            // Ideally refactor renderUsers to accept data array
        }
        
        window.editUser = async (uid, bal) => {
            const {value: newBal} = await Swal.fire({title:'Update Balance', input:'number', inputValue:bal, background:'#1e293b', color:'#fff'});
            if(newBal) await updateDoc(doc(db,"users",uid), {balance: parseFloat(newBal)});
        }

        function loadTasks() {
            onSnapshot(collection(db, "tasks"), snap => {
                const div = document.getElementById('tasks-grid');
                div.innerHTML = '';
                snap.forEach(d => {
                    const t = d.data();
                    div.innerHTML += `
                        <div class="glass-panel p-3 flex justify-between items-center rounded-lg">
                            <div><div class="font-bold text-white text-sm">${t.title}</div><div class="text-xs text-slate-400">${t.reward} Coins â€¢ ${t.seconds}s</div></div>
                            <button onclick="delTask('${d.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </div>`;
                });
            });
        }
        window.addTaskPopup = async () => {
            const {value: form} = await Swal.fire({
                title: 'New Task',
                html: '<input id="t-ti" class="swal2-input" placeholder="Title"><input id="t-ln" class="swal2-input" placeholder="Link"><input id="t-rw" type="number" class="swal2-input" placeholder="Reward"><input id="t-sc" type="number" class="swal2-input" placeholder="Seconds">',
                focusConfirm: false, background:'#1e293b', color:'#fff',
                preConfirm: () => [document.getElementById('t-ti').value, document.getElementById('t-ln').value, document.getElementById('t-rw').value, document.getElementById('t-sc').value]
            });
            if(form && form[0]) await addDoc(collection(db,"tasks"), {title:form[0], link:form[1], reward:+form[2], seconds:+form[3]});
        }
        window.delTask = (id) => deleteDoc(doc(db,"tasks",id));

        function loadSettings() {
            onSnapshot(doc(db,"settings","config"), s => {
                if(s.exists()){
                    const d = s.data();
                    document.getElementById('set-bonus').value = d.dailyBonus;
                    document.getElementById('set-min').value = d.minWithdraw;
                    document.getElementById('set-zone').value = d.monetagZoneId;
                    document.getElementById('set-notice').value = d.announcement;
                }
            });
            document.getElementById('settings-form').addEventListener('submit', async(e)=>{
                e.preventDefault();
                await updateDoc(doc(db,"settings","config"), {
                    dailyBonus: +document.getElementById('set-bonus').value,
                    minWithdraw: +document.getElementById('set-min').value,
                    monetagZoneId: document.getElementById('set-zone').value,
                    announcement: document.getElementById('set-notice').value
                });
                Swal.fire({icon:'success', title:'Saved', toast:true, position:'top-end', timer:1500, background:'#1e293b', color:'#fff', showConfirmButton:false});
            });
        }

        window.switchTab = (id) => {
            document.querySelectorAll('.page-view').forEach(e => e.classList.add('hide'));
            document.getElementById(`view-${id}`).classList.remove('hide');
            document.querySelectorAll('.sidebar-link').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

    </script>
</body>
</html>